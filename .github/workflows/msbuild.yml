name: CI & Release (MSBuild) – DumpChromeSecrets

on:
  push:
    branches: [ "**" ]     # run automatically on any branch update
    tags:
      - "v*.*.*"           # when tagging, publish a Release
  pull_request:
    branches: [ "**" ]

permissions:
  contents: write          # release upload needs write (build reads)

env:
  SOLUTION_FILE_PATH: DumpChromeSecrets.sln
  BUILD_CONFIGURATION: Release

jobs:
  build-and-maybe-release:
    name: Build (and release if tag)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64
      # Adds msbuild.exe to PATH on Windows runners. [3](https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax)

      - name: Restore NuGet packages
        run: nuget restore "${{ env.SOLUTION_FILE_PATH }}"

      - name: Build solution (Release | x64)
        run: msbuild "${{ env.SOLUTION_FILE_PATH }}" /m /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=x64
      # MSBuild invocation pattern from GitHub’s starter workflow. [4](https://www.karimrahal.com/2023/01/05/github-actions-leaking-secrets/)

      - name: Locate build outputs
        id: locate
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Recurse -File -Filter DumpChromeSecrets.exe | Where-Object { $_.FullName -match '\\bin\\Release\\|\\x64\\Release\\' } | Select-Object -First 1
          $dll = Get-ChildItem -Recurse -File -Filter DllExtractChromeSecrets.dll | Where-Object { $_.FullName -match '\\bin\\Release\\|\\x64\\Release\\' } | Select-Object -First 1

          if (-not $exe) { throw "DumpChromeSecrets.exe not found in typical Release folders." }
          if (-not $dll) { throw "DllExtractChromeSecrets.dll not found in typical Release folders." }

          "exe_path=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "dll_path=$($dll.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Prepare dist (binaries + hashes + timestamped checksums)
        id: dist
        shell: pwsh
        run: |
          $outDir = Join-Path $pwd "dist"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $exe = "${{ steps.locate.outputs.exe_path }}"
          $dll = "${{ steps.locate.outputs.dll_path }}"

          # Hash the files (SHA256 + SHA512). Get-FileHash supports both. [1](https://github.com/microsoft/setup-msbuild)
          $exeSha256 = (Get-FileHash -Path $exe -Algorithm SHA256).Hash
          $exeSha512 = (Get-FileHash -Path $exe -Algorithm SHA512).Hash
          $dllSha256 = (Get-FileHash -Path $dll -Algorithm SHA256).Hash
          $dllSha512 = (Get-FileHash -Path $dll -Algorithm SHA512).Hash

          # Sidecar hash files
          Set-Content -Path (Join-Path $outDir "DumpChromeSecrets.exe.sha256") -Value $exeSha256
          Set-Content -Path (Join-Path $outDir "DumpChromeSecrets.exe.sha512") -Value $exeSha512
          Set-Content -Path (Join-Path $outDir "DllExtractChromeSecrets.dll.sha256") -Value $dllSha256
          Set-Content -Path (Join-Path $outDir "DllExtractChromeSecrets.dll.sha512") -Value $dllSha512

          # Timestamp (ISO8601 UTC), commit, ref, sizes for provenance
          $timestampUtc = [DateTime]::UtcNow.ToString("o")    # e.g., 2025-12-30T08:28:05.1234567Z
          $commit = "${{ github.sha }}"
          $ref    = "${{ github.ref }}"
          $exeSize = (Get-Item $exe).Length
          $dllSize = (Get-Item $dll).Length

          $lines = @(
            "# Checksums generated at (UTC): $timestampUtc"
            "# Commit: $commit"
            "# Ref:    $ref"
            "# File sizes (bytes): DumpChromeSecrets.exe=$exeSize, DllExtractChromeSecrets.dll=$dllSize"
            "SHA256  DumpChromeSecrets.exe  $exeSha256"
            "SHA512  DumpChromeSecrets.exe  $exeSha512"
            "SHA256  DllExtractChromeSecrets.dll  $dllSha256"
            "SHA512  DllExtractChromeSecrets.dll  $dllSha512"
          )
          $checksums = Join-Path $outDir "checksums.txt"
          $lines | Set-Content -Path $checksums

          # Copy binaries so release uploads them as individual files (not zipped)
          Copy-Item -Path $exe -Destination (Join-Path $outDir "DumpChromeSecrets.exe") -Force
          Copy-Item -Path $dll -Destination (Join-Path $outDir "DllExtractChromeSecrets.dll") -Force

          "dist_dir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create/Update GitHub Release (tag only; separate files)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.dist.outputs.dist_dir }}/DumpChromeSecrets.exe
            ${{ steps.dist.outputs.dist_dir }}/DllExtractChromeSecrets.dll
            ${{ steps.dist.outputs.dist_dir }}/DumpChromeSecrets.exe.sha256
            ${{ steps.dist.outputs.dist_dir }}/DumpChromeSecrets.exe.sha512
            ${{ steps.dist.outputs.dist_dir }}/DllExtractChromeSecrets.dll.sha256
            ${{ steps.dist.outputs.dist_dir }}/DllExtractChromeSecrets.dll.sha512
            ${{ steps.dist.outputs.dist_dir }}/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Release assets are uploaded as-is; no ZIP wrapping. [2](https://cicube.io/blog/github-actions-secrets/)
